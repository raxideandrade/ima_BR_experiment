 %% Experimentt variables
clear all

% Global variables
global expt 
global win
global lum_output
%% General variables
lum_output = struct('dominant', [], 'lum_blue', [], 'response', []);  % Initialize the data structure
update = true;
stage = 0;
% There are 4 stages of the experiment: 1. pause, 2. show anaglyph,
% 3. listen for subject input, 4. show image according to input
dominant = '';
pre_dominant = ''; % Previously dominant
wasKeyDown = false;

expt.key = ''; % Exmpty string to store key pressed
expt.state = 0; % Keep track of the current state of the response keyboard

expt.event_dur = [2 0.7 0 2]; % Duration of four stages
expt.min_trials = 40 ; % Minimum number of trials
expt.max_trials = 100;
expt.isrunning = true;
expt.trial = 1;
expt.lumblue = 0.4;
expt.max_lumblue = 5; % Max possible value. Will be modified after 7th reversal
expt.min_lumblue = 0; % Min possible value. Will be modified after 7th reversal
expt.lumblue_arr = []; % Array to store lumblue values when a reversal happens
expt.correct_lumblue = true;
expt.mixed_arr = []; % Array to store lumblue values when subject votes 'mixed'
expt.mixed_votes = 0; % For indexing results
expt.step_size = 0.5; % Update luminance by n percent
expt.reversals = 0;
expt.reversal_threshold = 15; % Experimet stops when reached
% Display size should be changed according to experiment conditions using a formula
expt.display_size =  visual_angle2pixel(4,24,64,0);

%% Functions path
addpath(pwd);

%% Prepare experiment
Screen('Preference', 'SkipSyncTests', 1);
create_subject_data();
config_screen(); %% Initialize Psychtoolbox screen
display_instructions();
anaglyph_image(); % Create anaglyph, fore and background textures

%% Experiment loop
while expt.isrunning && expt.reversals <= expt.reversal_threshold && expt.trial <= expt.max_trials  
    
    expt.lumblue_mean = mean(expt.lumblue_arr);
    save(fullfile('output', ['luminance_', num2str(expt.subject), '.mat']), 'expt');
%     save('output/luminance_s.mat', 'expt',"-mat");
    % If n reversals set lumblue to its average so far in order to increase accuracy.
    % This could be change to hppen every 5 reversals with the mod() function
    if expt.reversals == 7 && expt.correct_lumblue
        expt.lumblue = expt.lumblue_mean;
		[expt.min_lumblue, expt.max_lumblue] = findNearestValues(expt.lumblue_arr);
		expt.correct_lumblue = false;

        if expt.lumblue_mean > 0.4
            expt.step_size = 0.3;
        end
        if expt.lumblue_mean < 0.4
            expt.step_size = 0.8 ;
        end
    end

    if update
        if stage == 4 && update == true
            upd_lum(dominant, pre_dominant);
            pre_dominant = dominant;
            expt.trial = expt.trial + 1;
            stage = 1;
        else
            stage = stage + 1;
        end
        time = upd_screen(stage, dominant, pre_dominant);
        update = false;

        expt.lumblue
    end

    if GetSecs - time >= expt.event_dur(stage)
        update = true;
        if stage == 3
            [dominant, wasKeyDown] = response(wasKeyDown); % Take subject input

            if strcmp(dominant, 'LeftArrow') || strcmp(dominant, 'RightArrow') || strcmp(dominant, 'DownArrow')
                
                % If input 'DownArrow' change dominant to pre_dominant
                % because mixed is considered as previous vote
                if strcmp(dominant, 'DownArrow')
                    expt.mixed_votes = expt.mixed_votes + 1;
                    expt.mixed_arr(expt.mixed_votes) = expt.lumblue;
                    dominant = pre_dominant;
                end

                expt.output(expt.trial, :) = [strcmp(dominant, 'LeftArrow') expt.lumblue]; % Store values
                lum_output(expt.trial).block_count = expt.block_count; 


                % Check for reversals
                if strcmp(dominant, pre_dominant) ~= 1 && strcmp(pre_dominant, '') ~= 1
                    expt.reversals = expt.reversals + 1; 
                    expt.lumblue_arr(expt.reversals) = expt.lumblue;
                end
            else
                % Subject used wrong key
                update = false;
            end
        end
    end
expt.lumblue_media = median(expt.lumblue_arr);

end
expt.luminance_median = median(expt.output(:,2));
expt.luminance_mean = mean(expt.output(:,2)); 

sca
